name: Deploy to Servers

on:
  push:
    branches:
      - main  # Gatilho para o deploy em produção, ao fazer push na branch 'main'

jobs:
  deploy-branix:
    name: Deploy to Branix
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      
      - name: Debug SSH Configuration
        env:
          HOST: ${{ secrets.HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22022' }}
        run: |
          echo "Testing SSH connection to server..."
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.USERNAME }}@$HOST "echo SSH connection successful"

      - name: Set deployment directory based on branch
        id: set-directory
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "DEPLOY_DIR=${{ secrets.DIRECTORY }}" >> $GITHUB_ENV
            echo "Using production directory: ${{ secrets.DIRECTORY }}"
          fi

      - name: Prepare deployment package 
        run: |
          echo "Preparando pacote de implantação com abordagem alternativa..."
          
          # Criar arquivo de implantação direto sem diretório temporário
          echo "Criando arquivo zip para implantação..."
          zip -r deployment.zip . -x "*.git*" -x "deployment.zip"
          
          echo "Arquivo de implantação criado com sucesso"
          ls -la deployment.zip

      - name: Upload to Branix
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22022' }}
        run: |
          echo "Enviando pacote de implantação para o servidor..."
          scp -v -P $SSH_PORT -o StrictHostKeyChecking=no deployment.zip $USERNAME@$HOST:~/
          
          echo "Upload concluído com sucesso."

      - name: Extract files on server
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22022' }}
        run: |
          echo "Extraindo arquivos no servidor..."
          ssh -p $SSH_PORT -o StrictHostKeyChecking=no $USERNAME@$HOST << EOF
            echo "Criando diretório, se não existir..."
            mkdir -p ${{ env.DEPLOY_DIR }}
            
            echo "Movendo pacote de implantação para o diretório de destino..."
            mv ~/deployment.zip ${{ env.DEPLOY_DIR }}/
            
            echo "Mudando para o diretório de destino..."
            cd ${{ env.DEPLOY_DIR }}
            
            echo "Extraindo pacote de implantação..."
            unzip -o deployment.zip
            
            echo "Limpando..."
            rm deployment.zip
            
            echo "Executando comandos pós-implantação..."
            php artisan optimize:clear
            php artisan migrate --force
            php artisan cache:clear
            php artisan route:clear
            
            echo "Extração concluída com sucesso."
          EOF

      - name: Notify deployment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Deployment to production environment completed"
          fi